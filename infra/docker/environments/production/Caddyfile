# Caddyfile para Producción
# Maneja HTTPS automático con Let's Encrypt

# API - api.notificaciones.space
api.notificaciones.space {
    # WebSocket proxy para Reverb (debe ir ANTES del reverse_proxy general)
    # Ruta específica para WebSocket connections (Laravel Echo usa /app/{key})
    handle /app/* {
        reverse_proxy reverb:8080 {
            # Headers necesarios para WebSocket upgrade
            header_up Connection {>Connection}
            header_up Upgrade {>Upgrade}
            header_up X-Real-IP {remote_host}
            header_up Host {host}
            
            # Timeout largo para mantener conexiones WebSocket activas
            transport http {
                dial_timeout 30s
                response_header_timeout 30s
            }
        }
    }

    # Reverse proxy a Nginx API (para todas las demás rutas, incluyendo /api/*)
    reverse_proxy nginx-api:80 {
        header_up X-Real-IP {remote_host}
        header_up Host {host}
        
        health_uri /up
        health_interval 30s
        health_timeout 5s
    }

    # Logging
    log {
        output file /var/log/caddy/api.log
        format json
    }

    # Compression
    encode gzip zstd
}

# Dashboard - dashboard.notificaciones.space
dashboard.notificaciones.space {
    # Reverse proxy a Dashboard
    reverse_proxy dashboard:80 {
        header_up X-Real-IP {remote_host}
        header_up Host {host}
        
        health_uri /
        health_interval 30s
        health_timeout 5s
    }

    # Logging
    log {
        output file /var/log/caddy/dashboard.log
        format json
    }

    # Compression
    encode gzip zstd
}


