# ============================================
# PATCH: Agregar servicio Reverb a docker-compose.yml
# ============================================
# 
# INSTRUCCIONES:
# 1. Abrir docker-compose.yml
# 2. Agregar el servicio "reverb" después del servicio "php-fpm"
# 3. Copiar el contenido de este archivo en la posición indicada
#
# Ubicación: Después de la línea 59 (después del servicio php-fpm)
# ============================================

  # ============================================
  # Reverb WebSocket Server
  # ============================================
  reverb:
    build:
      context: ../../../../apps/api
      dockerfile: ../../infra/docker/dockerfiles/Dockerfile.php-fpm
    container_name: yape-notifier-reverb-prod
    restart: always
    working_dir: /var/www
    command: php artisan reverb:start --host=0.0.0.0 --port=8080
    volumes:
      - ../../configs/php/production.ini:/usr/local/etc/php/conf.d/production.ini:ro
    env_file:
      - .env
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - APP_URL=${APP_URL:-https://api.notificaciones.space}
    networks:
      - yape-network-prod
    depends_on:
      db:
        condition: service_healthy
      php-fpm:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "php -r 'exit(0);'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.yape-notifier.service=reverb"
      - "com.yape-notifier.environment=production"
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M



